# 敌人行为优化更新日志

## 修复的问题

### 1. 怪物卡在墙里的问题
**问题描述**: 怪物在追击玩家时可能会卡在墙体内部，无法正常移动。

**解决方案**:
- 重写了`move_towards_target()`方法，改进移动逻辑
- 添加了多方向尝试移动的机制
- 新增了`try_avoid_wall()`方法，尝试8个方向的避障移动
- 改进了碰撞检测，先尝试直接移动，失败则分别尝试X/Y轴移动

### 2. 攻击距离判定问题
**问题描述**: 怪物必须与玩家完全重合才能攻击，不够真实。

**解决方案**:
- 将原来的"attack"状态改为"approach"状态
- 怪物靠近玩家到一定距离（35像素）时会停止移动
- 怪物不再自动攻击，只会跟随玩家

### 3. 删除碰撞伤害和自动攻击
**问题描述**: 怪物会自动攻击玩家，造成不必要的伤害。

**解决方案**:
- 完全移除了`handle_combat()`中的碰撞攻击逻辑
- 怪物只会跟随玩家，不会主动攻击
- 玩家需要通过技能（如火球术）主动攻击怪物

## 技术改进

### 1. 改进的移动算法
```python
def move_towards_target(self, target_x, target_y, game_map=None):
    """向目标移动 - 改进版本防止卡墙"""
    # 先尝试直接移动
    if game_map.can_move_to(new_x, new_y, self.width, self.height):
        self.x, self.y = new_x, new_y
    else:
        # 分别尝试X/Y轴移动
        # 如果都失败，尝试8方向避障
```

### 2. 新增避障机制
```python
def try_avoid_wall(self, game_map):
    """尝试避开墙体"""
    # 尝试8个方向的移动
    directions = [
        (1, 0), (0, 1), (-1, 0), (0, -1),  # 4个主方向
        (1, 1), (1, -1), (-1, 1), (-1, -1)  # 4个对角方向
    ]
```

### 3. 改进的AI状态机
- **patrol**: 巡逻状态（默认）
- **chase**: 追击状态（发现玩家时）
- **approach**: 靠近状态（接近玩家时，替代原attack状态）

## 文件修改列表

### 1. enemy.py
- 修改`update_ai()`方法，将"attack"状态改为"approach"
- 新增`approach_player()`方法，怪物靠近但不攻击
- 重写`move_towards_target()`方法，改进移动逻辑
- 新增`try_avoid_wall()`方法，实现智能避障

### 2. main.py
- 修改`handle_combat()`方法，移除碰撞攻击逻辑
- 怪物只更新AI，不进行攻击判定

### 3. game_enhanced.py
- 修改`handle_combat()`方法，移除碰撞攻击逻辑
- 保持与main.py相同的行为

### 4. launcher.py
- 添加"敌人行为测试"选项
- 更新选择提示为1-7

### 5. test_enemy_behavior.py（新增）
- 专门测试敌人行为的测试程序
- 实时显示敌人状态和距离信息
- 可以观察敌人的跟随、避障行为

## 游戏体验改进

### 1. 更自然的敌人行为
- 敌人会智能地跟随玩家
- 不会卡在墙体内部
- 靠近玩家时会保持适当距离

### 2. 更好的战斗体验
- 玩家需要主动攻击敌人
- 移除了被动的碰撞伤害
- 战斗更有策略性

### 3. 改进的AI表现
- 敌人会尝试绕过障碍物
- 更流畅的移动表现
- 不会出现"卡死"现象

## 测试方法

### 1. 启动敌人行为测试
```bash
python launcher.py
# 选择 "6. 敌人行为测试"
```

### 2. 观察要点
- 敌人是否会卡在墙体内
- 敌人是否会智能避开障碍物
- 敌人靠近玩家时是否会停止移动
- 敌人是否不再自动攻击

### 3. 完整游戏测试
```bash
python launcher.py
# 选择 "1. 增强版游戏"
```

## 后续可能的改进

1. **更智能的寻路算法**: 实现A*算法进行路径规划
2. **不同类型的敌人行为**: 有些敌人主动攻击，有些被动跟随
3. **敌人之间的协作**: 多个敌人的协同行为
4. **动态难度调整**: 根据玩家表现调整敌人行为

## 兼容性说明

- 完全兼容现有的技能系统
- 保持原有的战斗系统（玩家主动攻击）
- 不影响物品拾取和其他游戏机制
- 保持存档系统的兼容性
