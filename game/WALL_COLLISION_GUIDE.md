# 墙体碰撞系统说明

## 功能概述
墙体碰撞系统为艾诺迪亚风格RPG游戏提供了完整的墙体碰撞检测功能，使玩家和敌人无法穿越地图中的墙体。

## 主要特性

### 1. 地图生成与墙体系统
- **地图网格**: 25x18的瓦片地图，每个瓦片32x32像素
- **墙体类型**: 
  - 边界墙：围绕整个地图的边界
  - 随机墙体：15%概率在地图中生成
  - 房间结构：预定义的房间墙体布局
- **地图数据**: 使用0表示可走区域，1表示墙体

### 2. 碰撞检测机制
- **玩家碰撞**: 移动前检查目标位置是否为墙体
- **敌人碰撞**: AI移动时检查墙体阻挡
- **像素级检测**: 将像素坐标转换为网格坐标进行检测

### 3. 移动控制集成
- **WASD移动**: 按键事件处理时进行碰撞检测
- **连续移动**: 持续按键时的移动也进行碰撞检测
- **平滑移动**: 被阻挡时玩家位置保持不变

## 文件结构与实现

### 核心文件
- `map.py`: 地图类和碰撞检测逻辑
- `player.py`: 玩家移动和碰撞检测
- `enemy.py`: 敌人AI和碰撞检测
- `main.py`: 标准版游戏主循环
- `game_enhanced.py`: 增强版游戏主循环

### 关键方法
- `GameMap.is_wall(x, y)`: 检查指定位置是否为墙体
- `GameMap.can_move_to(x, y)`: 检查是否可以移动到指定位置
- `Player.handle_keydown_movement(key, game_map)`: 处理玩家移动
- `Enemy.update(player, game_map)`: 更新敌人AI并检查碰撞

## 使用方法

### 1. 运行游戏
```bash
python launcher.py
```

### 2. 选择游戏版本
- 选项1: 增强版游戏（推荐）
- 选项2: 标准版游戏
- 选项5: 墙体碰撞测试

### 3. 游戏控制
- **WASD**: 移动玩家
- **墙体碰撞**: 玩家和敌人会被墙体阻挡
- **视觉反馈**: 墙体显示为深色方块

## 测试功能

### 墙体碰撞测试 (test_wall_collision.py)
专门的测试程序用于验证墙体碰撞功能：
- 实时显示玩家和敌人位置
- 碰撞事件日志
- 移动轨迹追踪

### 测试步骤
1. 启动launcher.py
2. 选择"5. 墙体碰撞测试"
3. 使用WASD移动测试碰撞
4. 观察敌人AI的墙体回避行为

## 技术细节

### 坐标系统
- **屏幕坐标**: 像素坐标 (0-800, 0-600)
- **网格坐标**: 瓦片坐标 (0-24, 0-17)
- **转换公式**: grid_x = pixel_x // TILE_SIZE

### 碰撞检测算法
```python
def is_wall(self, x, y):
    """检查指定像素位置是否为墙体"""
    grid_x = x // self.TILE_SIZE
    grid_y = y // self.TILE_SIZE
    
    if 0 <= grid_x < self.WIDTH and 0 <= grid_y < self.HEIGHT:
        return self.grid[grid_y][grid_x] == 1
    return True  # 超出边界视为墙体
```

### 移动验证
```python
def can_move_to(self, x, y):
    """检查是否可以移动到指定位置"""
    # 检查角色四个角是否都不与墙体重叠
    size = 30  # 角色大小
    corners = [
        (x, y),                    # 左上角
        (x + size, y),             # 右上角
        (x, y + size),             # 左下角
        (x + size, y + size)       # 右下角
    ]
    
    for corner_x, corner_y in corners:
        if self.is_wall(corner_x, corner_y):
            return False
    return True
```

## 兼容性说明
- 完全兼容现有的战斗系统
- 保持原有的技能系统功能
- 支持所有移动控制方式
- 不影响物品拾取和交互系统

## 后续扩展
- 可添加不同类型的墙体（如可破坏墙体）
- 可实现复杂的地图结构（如门、开关）
- 可添加墙体材质和视觉效果
- 可实现投射物的墙体碰撞
